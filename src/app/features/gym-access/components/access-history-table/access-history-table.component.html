<!-- Filters Section -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
  <div class="p-6 border-b border-gray-200">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-gray-900">Filtros de Búsqueda</h3>
      <div class="flex items-center space-x-2">
        <span class="text-sm text-gray-500" *ngIf="hasActiveFilters()">
          {{ getActiveFiltersCount() }} filtro(s) activo(s)
        </span>
        <button
          mat-button
          color="warn"
          (click)="clearFilters()"
          *ngIf="hasActiveFilters()"
          class="text-sm">
          <mat-icon>clear</mat-icon>
          Limpiar Filtros
        </button>
      </div>
    </div>

    <!-- Filter Controls -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-4">
      <!-- Client Name Filter -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Nombre del Cliente</mat-label>
        <input
          matInput
          [(ngModel)]="localFilters.clientName"
          placeholder="Buscar por nombre..."
          (keyup.enter)="applyFilters()">
        <mat-icon matSuffix>person</mat-icon>
      </mat-form-field>

      <!-- Cedula Filter -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Cédula</mat-label>
        <input
          matInput
          [(ngModel)]="localFilters.cedula"
          placeholder="12345678"
          (keyup.enter)="applyFilters()"
          maxlength="8">
        <mat-icon matSuffix>badge</mat-icon>
      </mat-form-field>

      <!-- Start Date Filter -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Fecha Desde</mat-label>
        <input
          matInput
          [matDatepicker]="startPicker"
          [(ngModel)]="localFilters.startDate"
          readonly>
        <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
        <mat-datepicker #startPicker></mat-datepicker>
      </mat-form-field>

      <!-- End Date Filter -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Fecha Hasta</mat-label>
        <input
          matInput
          [matDatepicker]="endPicker"
          [(ngModel)]="localFilters.endDate"
          readonly>
        <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
        <mat-datepicker #endPicker></mat-datepicker>
      </mat-form-field>

      <!-- Success Filter -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Estado</mat-label>
        <mat-select [(ngModel)]="localFilters.successful">
          <mat-option *ngFor="let option of successOptions" [value]="option.value">
            {{ option.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Filter Actions -->
      <div class="flex items-end space-x-2">
        <button mat-raised-button color="primary" (click)="applyFilters()" class="flex-1">
          <mat-icon>search</mat-icon>
          Buscar
        </button>
      </div>
    </div>

    <!-- Quick Date Filters -->
    <div class="flex flex-wrap gap-2 mt-4">
      <span class="text-sm text-gray-600 mr-2">Filtros rápidos:</span>
      <button mat-stroked-button (click)="setQuickDateRange('today')" class="text-xs">
        Hoy
      </button>
      <button mat-stroked-button (click)="setQuickDateRange('week')" class="text-xs">
        Última Semana
      </button>
      <button mat-stroked-button (click)="setQuickDateRange('month')" class="text-xs">
        Último Mes
      </button>
    </div>
  </div>
</div>

<!-- Table Section -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200">
  <!-- Table Header -->
  <div class="p-6 border-b border-gray-200">
    <div class="flex items-center justify-between">
      <div>
        <h3 class="text-lg font-semibold text-gray-900">Historial de Accesos</h3>
        <p class="text-sm text-gray-600 mt-1">
          {{ totalCount }} registro(s) encontrado(s)
        </p>
      </div>
      
      <!-- Export Menu -->
      <div class="flex items-center space-x-2">
        <button mat-button [matMenuTriggerFor]="exportMenu" class="text-sm">
          <mat-icon>download</mat-icon>
          Exportar
        </button>
        <mat-menu #exportMenu="matMenu">
          <button mat-menu-item (click)="onExportData('csv')">
            <mat-icon>description</mat-icon>
            <span>Exportar CSV</span>
          </button>
          <button mat-menu-item (click)="onExportData('excel')">
            <mat-icon>table_chart</mat-icon>
            <span>Exportar Excel</span>
          </button>
        </mat-menu>
      </div>
    </div>
  </div>

  <!-- Table Content -->
  <div class="overflow-x-auto">
    <!-- Loading State -->
    <div *ngIf="loading" class="flex justify-center items-center p-8">
      <app-loader></app-loader>
    </div>

    <!-- Data Table -->
    <table
      mat-table
      [dataSource]="data"
      matSort
      (matSortChange)="onSortChange($event)"
      class="w-full"
      *ngIf="!loading">
      
      <!-- Access Date Column -->
      <ng-container matColumnDef="accessDate">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold">
          Fecha y Hora
        </th>
        <td mat-cell *matCellDef="let item" class="text-sm">
          {{ formatDisplayDate(item.accessDate) }}
        </td>
      </ng-container>

      <!-- Client Name Column -->
      <ng-container matColumnDef="clientName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold">
          Cliente
        </th>
        <td mat-cell *matCellDef="let item" class="text-sm">
          <div class="flex items-center space-x-3">
            <img
              [src]="getClientPhotoUrl(item.clientPhoto)"
              (error)="onPhotoError($event)"
              alt="Foto cliente"
              class="w-8 h-8 rounded-full object-cover">
            <span class="font-medium">{{ item.clientName }}</span>
          </div>
        </td>
      </ng-container>

      <!-- Cedula Column -->
      <ng-container matColumnDef="cedula">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold">
          Cédula
        </th>
        <td mat-cell *matCellDef="let item" class="text-sm font-mono">
          {{ formatCedula(item.cedula) }}
        </td>
      </ng-container>

      <!-- Plan Name Column -->
      <ng-container matColumnDef="planName">
        <th mat-header-cell *matHeaderCellDef class="font-semibold">
          Plan
        </th>
        <td mat-cell *matCellDef="let item" class="text-sm">
          <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
            {{ item.planName }}
          </span>
        </td>
      </ng-container>

      <!-- Success Status Column -->
      <ng-container matColumnDef="success">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold">
          Estado
        </th>
        <td mat-cell *matCellDef="let item" class="text-sm">
          <app-badge
            [textBadge]="getStatusText(item.success, item.reason)"
            [colorBadge]="getStatusBadgeColor(item.success)">
          </app-badge>
        </td>
      </ng-container>

      <!-- Consecutive Days Column -->
      <ng-container matColumnDef="consecutiveDays">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold">
          Días Consecutivos
        </th>
        <td mat-cell *matCellDef="let item" class="text-sm">
          <app-badge
            [textBadge]="(item.consecutiveDays || 0).toString()"
            [colorBadge]="getConsecutiveDaysBadgeColor(item.consecutiveDays || 0)">
          </app-badge>
        </td>
      </ng-container>

      <!-- Reward Column -->
      <ng-container matColumnDef="rewardEarned">
        <th mat-header-cell *matHeaderCellDef class="font-semibold">
          Recompensa
        </th>
        <td mat-cell *matCellDef="let item" class="text-sm">
          <div *ngIf="hasReward(item)" class="flex items-center space-x-1">
            <mat-icon class="text-yellow-500" style="font-size: 16px;">emoji_events</mat-icon>
            <span class="text-yellow-700 font-medium text-xs">{{ getRewardText(item) }}</span>
          </div>
          <span *ngIf="!hasReward(item)" class="text-gray-400">-</span>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="font-semibold">
          Acciones
        </th>
        <td mat-cell *matCellDef="let item" class="text-sm">
          <button
            mat-icon-button
            (click)="onViewClientDetail(item.cedula)"
            matTooltip="Ver perfil del cliente"
            class="text-blue-600 hover:text-blue-800">
            <mat-icon>person</mat-icon>
          </button>
        </td>
      </ng-container>

      <!-- Table Header and Rows -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns" class="bg-gray-50"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"
          class="hover:bg-gray-50 transition-colors duration-200"></tr>
    </table>

    <!-- No Data State -->
    <div *ngIf="!loading && data.length === 0" class="text-center py-12">
      <mat-icon class="text-gray-400 text-6xl mb-4">inbox</mat-icon>
      <h3 class="text-lg font-medium text-gray-900 mb-2">No hay datos disponibles</h3>
      <p class="text-gray-600">
        {{ hasActiveFilters() ? 'No se encontraron resultados con los filtros aplicados.' : 'No hay registros de acceso disponibles.' }}
      </p>
      <button
        *ngIf="hasActiveFilters()"
        mat-button
        color="primary"
        (click)="clearFilters()"
        class="mt-4">
        Limpiar Filtros
      </button>
    </div>
  </div>

  <!-- Pagination -->
  <div class="border-t border-gray-200" *ngIf="!loading && data.length > 0">
    <mat-paginator
      [length]="totalCount"
      [pageSize]="pageSize"
      [pageIndex]="currentPage"
      [pageSizeOptions]="[5, 10, 25, 50, 100]"
      (page)="onPageChange($event)"
      showFirstLastButtons
      class="bg-gray-50">
    </mat-paginator>
  </div>
</div>